#include <avr/io.h>

// Function to control servo motor position
void servoRun(uint8_t degree)
{
    // 0도 OCR = 1000;
    // 180도 OCR = 5000;
    uint16_t degValue;

    // Ensure the degree is within the valid range
    if (degree < 0)
    {
        degree = 0;
    }
    else if (degree > 180)
    {
        degree = 180;
    }

    degValue = (uint16_t)((degree / 180.0) * (5000 - 1000) + 1000);
    OCR1A = degValue;
}

int currentAngle = 90;  
int angleChange;      

void setup() {
  Serial.begin(9600);    
  DDRB |= (1 << PB1);   

  
  TCCR1A = 0;            
  TCCR1B = 0;            

  // PWM14
  TCCR1B |= (1 << WGM13) | (1 << WGM12);
  TCCR1A |= (1 << WGM11);

  
  TCCR1A |= (1 << COM1A1);

  //8
  TCCR1B |= (1 << CS11);

  // TOP
  ICR1 = 39999;

  
  servoRun(currentAngle);

  Serial.println("Enter angle change (-180 to 180):"); 
}

void loop() {
  if (Serial.available()) {  
    angleChange = Serial.parseInt();  
    if (angleChange >= -180 && angleChange <= 180) {  
      currentAngle += angleChange;  
      if (currentAngle < 0) currentAngle = 0;  
      if (currentAngle > 180) currentAngle = 180;  
      
      
      servoRun(currentAngle);
      Serial.print("Moved to: ");
      Serial.print(currentAngle);
      Serial.println(" degrees");
    } else {
      Serial.println("Invalid angle change. Enter a value between -180 and 180.");
    }
    Serial.println("Enter angle change (-180 to 180):");  

    // 버퍼비우기
    while (Serial.available() > 0) {
      Serial.read();
    }
  }
}
