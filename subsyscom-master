#include <avr/io.h>
#include <Arduino.h>

// 서보 모터 제어 함수
void servoRun(uint8_t motor, uint8_t degree)
{
    uint16_t degValue;

    if (degree < 0)
    {
        degree = 0;
    }
    else if (degree > 180)
    {
        degree = 180;
    }

    degValue = (uint16_t)((degree / 180.0) * (5000 - 1000) + 1000);

    if (motor == 1) {
        OCR1A = degValue;  // Motor 1 (핀 9)
    } else if (motor == 2) {
        OCR1B = degValue;  // Motor 2 (핀 10)
    }
}

int currentAngle1 = 90;
int currentAngle2 = 90;

void setup() {
  // 시리얼 통신 시작
  Serial.begin(9600);

  // 서보 모터 설정
  DDRB |= (1 << PB1) | (1 << PB2);

  // SPI 설정
  DDRB |= (1 << PB3) | (1 << PB5) | (1 << PB2); // MOSI, SCK, SS를 출력으로 설정
  SPCR |= (1 << SPE) | (1 << MSTR) | (1 << SPR0); // SPI 활성화, Master 모드 설정, 클럭 속도 분주 설정

  Serial.println("SPI initialized.");

  // 서보 모터 PWM 설정
  TCCR1A = 0;
  TCCR1B = 0;

  TCCR1B |= (1 << WGM13) | (1 << WGM12);
  TCCR1A |= (1 << WGM11);

  TCCR1A |= (1 << COM1A1) | (1 << COM1B1);

  TCCR1B |= (1 << CS11);

  ICR1 = 39999;

  servoRun(1, currentAngle1);
  servoRun(2, currentAngle2);

  Serial.println("Servo motors initialized at 90 degrees.");

  Serial.println("Enter angle changes (-180 to 180) for motor 1 and motor 2 separated by a comma (e.g., 10,-20):");
}

uint8_t spi_transfer(uint8_t data) {
  SPDR = data;
  while (!(SPSR & (1 << SPIF)));
  return SPDR;
}

void loop() {
  if (Serial.available()) {
    String input = Serial.readStringUntil('\n');
    int commaIndex = input.indexOf(',');
    if (commaIndex > 0) {
      int angleChange1 = input.substring(0, commaIndex).toInt();
      int angleChange2 = input.substring(commaIndex + 1).toInt();

      currentAngle1 += angleChange1;
      currentAngle2 += angleChange2;

      if (currentAngle1 < 0) currentAngle1 = 0;
      if (currentAngle1 > 180) currentAngle1 = 180;
      if (currentAngle2 < 0) currentAngle2 = 0;
      if (currentAngle2 > 180) currentAngle2 = 180;

      servoRun(1, currentAngle1);
      servoRun(2, currentAngle2);

      Serial.print("Motor 1 moved to: ");
      Serial.print(currentAngle1);
      Serial.println(" degrees");
      Serial.print("Motor 2 moved to: ");
      Serial.print(currentAngle2);
      Serial.println(" degrees");

      // SPI 통신을 통해 슬레이브에게 명령 전송
      digitalWrite(PB2, LOW); // SS 핀 Low
      Serial.println("Sending angles to slave...");
      spi_transfer(currentAngle1);
      spi_transfer(currentAngle2);
      digitalWrite(PB2, HIGH); // SS 핀 High
      Serial.println("Angles sent.");
    } else {
      Serial.println("Invalid input format. Please enter two angle changes separated by a comma.");
    }

    Serial.println("Enter angle changes (-180 to 180) for motor 1 and motor 2 separated by a comma (e.g., 10,-20):");

    while (Serial.available() > 0) {
      Serial.read();
    }
  }
}
