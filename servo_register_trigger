#include <avr/io.h>

// Function to control servo motor position
void servoRun(int degree)
{
    // 0도에서 180도 사이의 각도를 PWM 값으로 변환
    uint16_t degValue;

    if (degree < 0)
    {
        degree = 0;
    }
    else if (degree > 180)
    {
        degree = 180;
    }

    // 각도를 PWM 값으로 변환
    degValue = (uint16_t)((degree / 180.0) * (5000 - 1000) + 1000);
    OCR1A = degValue;
}

int initialAngle = 90;  // 초기 각도
int angleChange = 30;   // 30도 변경 값

void setup() {
  Serial.begin(9600);
  DDRB |= (1 << PB1);  // PB1 핀을 출력으로 설정

  TCCR1A = 0;
  TCCR1B = 0;

  // PWM 모드 14
  TCCR1B |= (1 << WGM13) | (1 << WGM12);
  TCCR1A |= (1 << WGM11);
  TCCR1A |= (1 << COM1A1);
  TCCR1B |= (1 << CS11);

  // TOP 값
  ICR1 = 39999;

  // 초기 서보모터 위치 설정
  servoRun(initialAngle);

  Serial.println("Enter any value to rotate servo 30 degrees and then return to initial position after 1 second:");
}

void loop() {
  if (Serial.available()) {
    while (Serial.available() > 0) {
      Serial.read();  // 입력 버퍼 비우기
    }

    // 서보모터 30도 회전
    int currentAngle = initialAngle + angleChange;
    servoRun(currentAngle);
    Serial.print("Moved to: ");
    Serial.print(currentAngle);
    Serial.println(" degrees");

    // 1초 대기
    delay(1000);

    // 서보모터 초기 위치로 복귀
    servoRun(initialAngle);
    Serial.print("Returned to: ");
    Serial.print(initialAngle);
    Serial.println(" degrees");

    // 입력 안내 메시지 다시 출력
    Serial.println("Enter any value to rotate servo 30 degrees and then return to initial position after 1 second:");
  }
}
